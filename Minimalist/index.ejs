<!DOCTYPE html>
<html>
<body>
<script>
let accessToken = null;
let logoutTimer = null;

// --- JWT auto-logout setup ---
function setAutoLogout(exp) {
  const now = Math.floor(Date.now() / 1000);
  const delay = (exp - now) * 1000;
  if (logoutTimer) clearTimeout(logoutTimer);
  logoutTimer = setTimeout(() => {
    accessToken = null;
    console.log('Token expired. Logged out automatically.');
  }, delay);
}

// --- Login function ---
async function login(username, password, mode) {
  const res = await fetch('/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username, password, mode }),
    credentials: mode === 'session' ? 'include' : undefined
  });
  const data = await res.json();

  if (!res.ok) return console.log(data);

  if (mode === 'jwt') {
    accessToken = data.accessToken;
    const payload = JSON.parse(atob(accessToken.split('.')[1]));
    setAutoLogout(payload.exp);
    console.log('Logged in with JWT', accessToken);
  } else {
    console.log('Logged in with session');
  }
}

// --- Logout function ---
async function logout() {
  accessToken = null;
  if (logoutTimer) clearTimeout(logoutTimer);
  const res = await fetch('/logout', {
    method: 'POST',
    credentials: 'include'
  });
  console.log(await res.json());
}

// --- Call protected route ---
async function getProtected() {
  const headers = {};
  if (accessToken) headers['Authorization'] = 'Bearer ' + accessToken;

  const res = await fetch('/protected', {
    headers,
    credentials: 'include'
  });
  console.log(await res.json());
}

/* Usage examples:
login('alice','password123','jwt').then(() => getProtected());
login('alice','password123','session').then(() => getProtected());
logout();
*/
</script>
</body>
</html>